<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>Integration of Keycloak and Dropwizard</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<link rel="stylesheet" href="css//asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="css//coderay-asciidoctor.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Integration of Keycloak and Dropwizard</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_about">1. About</a>
<ul class="sectlevel2">
<li><a href="#_summary">1.1. Summary</a></li>
<li><a href="#_things_to_do">1.2. Things to do</a></li>
<li><a href="#_prerequisites">1.3. Prerequisites</a></li>
<li><a href="#_parts">1.4. Parts</a></li>
<li><a href="#_license">1.5. License</a></li>
</ul>
</li>
<li><a href="#_simple_web_application">2. Simple Web Application</a>
<ul class="sectlevel2">
<li><a href="#_what_you_can_see_here">2.1. What you can see here</a></li>
<li><a href="#_how_to_run">2.2. How to run</a></li>
</ul>
</li>
<li><a href="#_keycloak_enabled_web_application">3. Keycloak enabled Web Application</a>
<ul class="sectlevel2">
<li><a href="#_what_you_can_see_here_2">3.1. What you can see here</a></li>
<li><a href="#_things_that_have_been_added_for_keycloak">3.2. Things that have been added for Keycloak</a></li>
<li><a href="#_how_to_run_2">3.3. How to run</a></li>
</ul>
</li>
<li><a href="#_simple_dropwizard_integration">4. Simple Dropwizard Integration</a>
<ul class="sectlevel2">
<li><a href="#_what_you_can_see_here_3">4.1. What you can see here</a></li>
<li><a href="#_setup_for_keycloak">4.2. Setup for Keycloak</a></li>
<li><a href="#_how_to_run_3">4.3. How to run</a></li>
</ul>
</li>
<li><a href="#_advanced_dropwizard_integration">5. Advanced Dropwizard Integration</a>
<ul class="sectlevel2">
<li><a href="#_what_you_can_see_here_4">5.1. What you can see here</a></li>
<li><a href="#_setup_for_keycloak_2">5.2. Setup for Keycloak</a></li>
<li><a href="#_how_to_run_4">5.3. How to run</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_about">1. About</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_summary">1.1. Summary</h3>
<div class="paragraph">
<p>This project shows how JBoss Keycloak and Dropwizard can be used together.</p>
</div>
<div class="paragraph">
<p><a href="http://keycloak.org" target="_blank">JBoss Keycloak</a> provides a standalone OAuth 2.0 and Open ID Connect server.
It handles user credentials for you application, so you can focus on business requirements.</p>
</div>
<div class="paragraph">
<p><a href="http://dropwizard.io" target="_blank">Dropwizard</a> is a Java framework for developing ops-friendly, high-performance, RESTful web services.</p>
</div>
<div class="paragraph">
<p><strong>TL;DR:</strong> The module
<a href="https://github.com/ahus1/keycloak-dropwizard-integration/tree/master/keycloak-dropwizard-jaxrs">keycloak-dropwizard-jaxrs</a>
shows how to use Dropwizard&#8217;s <code>@Auth</code> annotation with Keycloak using a full OAuth flow.</p>
</div>
<div class="paragraph">
<p>At the time I write this there is no open source integration of the two, so I set up this project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_things_to_do">1.2. Things to do</h3>
<div class="paragraph">
<p>Over time the Sources in the module <code>keycloak-dropwizard-jaxrs</code> will probably evolve to a ready-to-user Dropwizard module.</p>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisites">1.3. Prerequisites</h3>
<div class="paragraph">
<p>These examples need a local JBoss Keycloak instance with Realm <code>test</code> and user <code>demo</code> with password <code>demo</code>.</p>
</div>
<div class="paragraph">
<p>Please download the Keycloak distribution version 1.5.0 from <a href="http://keycloak.org" class="bare">http://keycloak.org</a> and extract it to a subfolder <code>keycloak-server</code> of this directory.
Then call <code>keycloak-server.bat</code> to import an already configured realm. Using this startup file the configuration will be reset every time you start Keycloak.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parts">1.4. Parts</h3>
<div class="paragraph">
<p>This example will guide you through setting up JBoss Keycloak in several configurations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simple Integration for <a href="http://dropwizard.io" target="_blank">Dropwizard</a><br>
see <a href="keycloak-dropwizard-jetty/README.html#keycloak-dropwizard-jetty">module keycloak-dropwizard-jetty</a>.</p>
</li>
<li>
<p>Advanced Integration <a href="http://dropwizard.io" target="_blank">Dropwizard</a><br>
see <a href="keycloak-dropwizard-jaxrs/README.html#keycloak-dropwizard-jaxrs">module keycloak-dropwizard-jaxrs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For completeness and an even simple setup a standard Servlet configuration is also included (without and with Keycloak):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simple Servlet<br>
see <a href="simple-war/README.html#simple-war">module simple-war</a>.</p>
</li>
<li>
<p>Servlet with Keycloak<br>
see <a href="keycloak-war/README.html#keycloak-war">module keycloak-war</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_license">1.5. License</h3>
<div class="paragraph">
<p>Copyright 2015 Alexander Schwartz</p>
</div>
<div class="paragraph">
<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
</div>
<div class="paragraph">
<p><a href="http://www.apache.org/licenses/LICENSE-2.0" class="bare">http://www.apache.org/licenses/LICENSE-2.0</a></p>
</div>
<div class="paragraph">
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simple_web_application">2. Simple Web Application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_you_can_see_here">2.1. What you can see here</h3>
<div class="paragraph">
<p>This is a very simple JEE web application that uses a servlet and a Freemarker template to show the information about one draw.</p>
</div>
<div class="paragraph">
<p>It does not yet contain any form of authentication. The Maven configuration will automatically start up Jetty as a Servlet container.</p>
</div>
<div class="paragraph">
<p>The porpose of this application is to show in the next step what you&#8217;ll need to add in order to get authentication with Keycloak up and running.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_run">2.2. How to run</h3>
<div class="paragraph">
<p>Use the following command line to start it from the parent&#8217;s directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn test -pl simple-war -am -Psimple-war</pre>
</div>
</div>
<div class="paragraph">
<p>Once it is started, point your browser to <a href="http://localhost:9090" class="bare">http://localhost:9090</a> to see the application.</p>
</div>
<div class="paragraph">
<p>Enter a date like <code>2015-01-01</code> to see the predicted results of the given date.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_keycloak_enabled_web_application">3. Keycloak enabled Web Application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_you_can_see_here_2">3.1. What you can see here</h3>
<div class="paragraph">
<p>This is the sample application as <code>simple-war</code>, but now it has been enhanced to support login via Keycloak.</p>
</div>
</div>
<div class="sect2">
<h3 id="_things_that_have_been_added_for_keycloak">3.2. Things that have been added for Keycloak</h3>
<div class="paragraph">
<p>The following bits and piece have been added to the application as described in the Keycloak manual:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Additions to <code>web.xml</code></p>
<div class="listingblock">
<div class="title">web.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;security-constraint&gt;</span>
    <span class="tag">&lt;web-resource-collection&gt;</span>
        <span class="tag">&lt;web-resource-name&gt;</span>Customers<span class="tag">&lt;/web-resource-name&gt;</span>
        <span class="tag">&lt;url-pattern&gt;</span>/*<span class="tag">&lt;/url-pattern&gt;</span>
    <span class="tag">&lt;/web-resource-collection&gt;</span>
    <span class="tag">&lt;auth-constraint&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/auth-constraint&gt;</span>
<span class="tag">&lt;/security-constraint&gt;</span>

<span class="tag">&lt;security-role&gt;</span>
    <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
<span class="tag">&lt;/security-role&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>New file <code>jetty-web.xml</code></p>
<div class="listingblock">
<div class="title">jetty-web.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="tag">&lt;Configure</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.webapp.WebAppContext</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;Get</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Set</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;New</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jetty.KeycloakJettyAuthenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;/New&gt;</span>
        <span class="tag">&lt;/Set&gt;</span>
    <span class="tag">&lt;/Get&gt;</span>
<span class="tag">&lt;/Configure&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>keycloak.json</code> to hold keycloak configuration</p>
</li>
<li>
<p>Addition to <code>DrawServlet</code> to show principal information</p>
<div class="listingblock">
<div class="title">DrawServlet.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">request.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">idToken</span><span class="delimiter">&quot;</span></span>, ((KeycloakPrincipal)request.getUserPrincipal())
        .getKeycloakSecurityContext().getIdToken());</code></pre>
</div>
</div>
</li>
<li>
<p>Addition to <code>index.ftl</code> to show principal information and to allow logout</p>
<div class="listingblock">
<div class="title">index.ftl</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="freemarker">Hello, ${idToken.name?html}!
(&lt;a href=&quot;logout&quot;&gt;logout&lt;/a&gt;)</code></pre>
</div>
</div>
</li>
<li>
<p><code>logout.tfl</code> to show a logout page</p>
</li>
<li>
<p><code>LogoutServlet.java</code> to support logout</p>
<div class="listingblock">
<div class="title">LogoutServlet.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@WebServlet</span>(urlPatterns = <span class="string"><span class="delimiter">&quot;</span><span class="content">/logout</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">LogoutServlet</span> <span class="directive">extends</span> HttpServlet {

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> doGet(HttpServletRequest request, HttpServletResponse response)
            <span class="directive">throws</span> ServletException, <span class="exception">IOException</span> {
        request.logout();
        request.getRequestDispatcher(<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout.ftl</span><span class="delimiter">&quot;</span></span>).forward(request, response);
    }

}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_run_2">3.3. How to run</h3>
<div class="paragraph">
<p>Please startup Keycloak as described in the introduction.</p>
</div>
<div class="paragraph">
<p>Use the following command line to start the application from the parent&#8217;s directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn test -pl keycloak-war -am -Pkeycloak-war</pre>
</div>
</div>
<div class="paragraph">
<p>Once it is started, point your browser to <a href="http://localhost:9090" class="bare">http://localhost:9090</a> to see the application.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll be redirected to the Keycloak login screen. Use username <code>demo</code> and password <code>demo</code> to log in.</p>
</div>
<div class="paragraph">
<p>Enter a date like <code>2015-01-01</code> to see the predicted results of the given date.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simple_dropwizard_integration">4. Simple Dropwizard Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_you_can_see_here_3">4.1. What you can see here</h3>
<div class="paragraph">
<p>This is a very simple Dropwizard application setup to use Freemarker as templating.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_for_keycloak">4.2. Setup for Keycloak</h3>
<div class="paragraph">
<p>The following elements add Keycloak authentication to Dropwizard:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add Keycloak information to <code>config.yml</code></p>
<div class="listingblock">
<div class="title">config.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">server</span>:
  <span class="key">applicationConnectors</span>:
      - <span class="string"><span class="content">type: http</span></span>
        <span class="key">port</span>: <span class="string"><span class="content">9090</span></span>
  <span class="key">adminConnectors</span>:
      - <span class="string"><span class="content">type: http</span></span>
        <span class="key">port</span>: <span class="string"><span class="content">9091</span></span>

<span class="key">keycloakConfiguration</span>:
  <span class="key">realm</span>: <span class="string"><span class="content">test</span></span>
  <span class="key">realmKey</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">MIIB...AQAB</span><span class="delimiter">&quot;</span></span>
  <span class="key">authServerUrl</span>: <span class="string"><span class="content">http://localhost:8080/auth</span></span>
  <span class="key">sslRequired</span>: <span class="string"><span class="content">none</span></span>
  <span class="key">registerNodeAtStartup</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">registerNodePeriod</span>: <span class="string"><span class="content">600</span></span>
  <span class="key">resource</span>: <span class="string"><span class="content">test</span></span>
  <span class="key">credentials</span>:
    <span class="key">secret</span>: <span class="string"><span class="content">7abd7d08-b10f-4513-bbba-aebebddabb45</span></span></code></pre>
</div>
</div>
</li>
<li>
<p>Add Keycloak to <code>LotteryConfiguration.java</code></p>
<div class="listingblock">
<div class="title">LotteryConfiguration.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LotteryConfiguration</span> <span class="directive">extends</span> <span class="predefined-type">Configuration</span> {

    <span class="directive">private</span> AdapterConfig keycloakConfiguration = <span class="keyword">new</span> AdapterConfig();

    <span class="directive">public</span> AdapterConfig getKeycloakConfiguration() {
        <span class="keyword">return</span> keycloakConfiguration;
    }

    <span class="directive">public</span> <span class="type">void</span> setKeycloakConfiguration(AdapterConfig keycloakConfiguration) {
        <span class="local-variable">this</span>.keycloakConfiguration = keycloakConfiguration;
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Setup security constraint previously setup in <code>web.xml</code>, now in <code>LotteryApplication.java</code></p>
<div class="listingblock">
<div class="title">LotteryApplication.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConstraintSecurityHandler securityHandler = <span class="keyword">new</span> ConstraintSecurityHandler();
environment.getApplicationContext().setSecurityHandler(securityHandler);
securityHandler.addRole(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
ConstraintMapping constraintMapping = <span class="keyword">new</span> ConstraintMapping();
constraintMapping.setPathSpec(<span class="string"><span class="delimiter">&quot;</span><span class="content">/*</span><span class="delimiter">&quot;</span></span>);
Constraint constraint = <span class="keyword">new</span> Constraint();
constraint.setAuthenticate(<span class="predefined-constant">true</span>);
constraint.setRoles(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span>{<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>});
constraintMapping.setConstraint(constraint);
securityHandler.addConstraintMapping(constraintMapping);</code></pre>
</div>
</div>
</li>
<li>
<p>Setup keycloak previously setup in <code>jetty-web.xml</code>, now in <code>LotteryApplication.java</code></p>
<div class="listingblock">
<div class="title">LotteryApplication.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">KeycloakJettyAuthenticator keycloak = <span class="keyword">new</span> KeycloakJettyAuthenticator();
environment.getApplicationContext().getSecurityHandler().setAuthenticator(keycloak);
keycloak.setAdapterConfig(configuration.getKeycloakConfiguration());</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_run_3">4.3. How to run</h3>
<div class="paragraph">
<p>Use the following command line to start it from the parent&#8217;s directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn test -pl keycloak-dropwizard-jetty -am -Peycloak-dropwizard-jetty</pre>
</div>
</div>
<div class="paragraph">
<p>Once it is started, point your browser to <a href="http://localhost:9090" class="bare">http://localhost:9090</a> to see the application.</p>
</div>
<div class="paragraph">
<p>Enter a date like <code>2015-01-01</code> to see the predicted results of the given date.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_dropwizard_integration">5. Advanced Dropwizard Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_you_can_see_here_4">5.1. What you can see here</h3>
<div class="paragraph">
<p>This is a setup that builds upon the simple integration.
But instead of relying on security constraints it uses Dropwizard&#8217;s <code>@Auth</code> annotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_for_keycloak_2">5.2. Setup for Keycloak</h3>
<div class="paragraph">
<p>The following elements add Keycloak authentication to Dropwizard and are identical to the simple setup:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add Keycloak information to <code>config.yml</code></p>
<div class="listingblock">
<div class="title">config.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">server</span>:
  <span class="key">applicationConnectors</span>:
      - <span class="string"><span class="content">type: http</span></span>
        <span class="key">port</span>: <span class="string"><span class="content">9090</span></span>
  <span class="key">adminConnectors</span>:
      - <span class="string"><span class="content">type: http</span></span>
        <span class="key">port</span>: <span class="string"><span class="content">9091</span></span>

<span class="key">keycloakConfiguration</span>:
  <span class="key">realm</span>: <span class="string"><span class="content">test</span></span>
  <span class="key">realmKey</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">MIIB...AQAB</span><span class="delimiter">&quot;</span></span>
  <span class="key">authServerUrl</span>: <span class="string"><span class="content">http://localhost:8080/auth</span></span>
  <span class="key">sslRequired</span>: <span class="string"><span class="content">none</span></span>
  <span class="key">registerNodeAtStartup</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">registerNodePeriod</span>: <span class="string"><span class="content">600</span></span>
  <span class="key">resource</span>: <span class="string"><span class="content">test</span></span>
  <span class="key">credentials</span>:
    <span class="key">secret</span>: <span class="string"><span class="content">7abd7d08-b10f-4513-bbba-aebebddabb45</span></span></code></pre>
</div>
</div>
</li>
<li>
<p>Add Keycloak as a security constraint to <code>LotteryConfiguration.java</code>, but without the role and URL mappings.</p>
<div class="listingblock">
<div class="title">LotteryConfiguration.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LotteryConfiguration</span> <span class="directive">extends</span> <span class="predefined-type">Configuration</span> {

    <span class="directive">private</span> AdapterConfig keycloakConfiguration = <span class="keyword">new</span> AdapterConfig();

    <span class="directive">public</span> AdapterConfig getKeycloakConfiguration() {
        <span class="keyword">return</span> keycloakConfiguration;
    }

    <span class="directive">public</span> <span class="type">void</span> setKeycloakConfiguration(AdapterConfig keycloakConfiguration) {
        <span class="local-variable">this</span>.keycloakConfiguration = keycloakConfiguration;
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Setup security constraint handler</p>
<div class="listingblock">
<div class="title">LotteryApplication.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">KeycloakJettyAuthenticator keycloak = <span class="keyword">new</span> KeycloakDropwizardAuthenticator();
keycloak.setAdapterConfig(configuration.getKeycloakConfiguration());
ConstraintSecurityHandler securityHandler = <span class="keyword">new</span> ConstraintSecurityHandler();
environment.getApplicationContext().setSecurityHandler(securityHandler);
environment.getApplicationContext().getSecurityHandler().setAuthenticator(keycloak);</code></pre>
</div>
</div>
</li>
<li>
<p>Setup keycloak as an Authentication Handler in Dropwizard style:</p>
<div class="listingblock">
<div class="title">LotteryApplication.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">KeycloakAuthFactory authFactory = <span class="keyword">new</span> KeycloakAuthFactory(configuration.getKeycloakConfiguration(), <span class="string"><span class="delimiter">&quot;</span><span class="content">dropwizard</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> KeycloakAuthenticator(), Authentication.class);
environment.jersey().register(AuthFactory.binder(authFactory));</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once this is set up, Dropwizard&#8217;s <code>@Auth</code> annotation can be used as usual in ressources:</p>
</div>
<div class="listingblock">
<div class="title">DrawRessource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(MediaType.TEXT_HTML)
<span class="directive">public</span> <span class="type">class</span> <span class="class">DrawRessource</span> {

    <span class="annotation">@POST</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/draw</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> DrawView draw(<span class="annotation">@FormParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> dateAsString, <span class="annotation">@Auth</span> Authentication auth) { <i class="conum" data-value="1"></i><b>(1)</b>
        auth.checkUserInRole(<span class="predefined-type">Role</span>.USER);
        DrawBean bean = <span class="keyword">new</span> DrawBean();
        LocalDate date = LocalDate.parse(dateAsString);
        bean.setDraw(DrawingService.drawNumbers(date));
        DrawView view = <span class="keyword">new</span> DrawView(bean);
        bean.setIdToken(auth.getIdToken());
        <span class="keyword">return</span> view;
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> LogoutView logout(<span class="annotation">@Auth</span>(required = <span class="predefined-constant">false</span>) Authentication auth) <span class="directive">throws</span> ServletException { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// request.logout(); // no effect as we didn't hook into jetty</span>
        <span class="keyword">if</span> (auth != <span class="predefined-constant">null</span>) {
            auth.logout();
        }
        <span class="keyword">return</span> <span class="keyword">new</span> LogoutView();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This enforces authentication of the user, possibly triggering a full OAuth redirect flow</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>An optional authentication provides the authentication details if the user is logged in already</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_run_4">5.3. How to run</h3>
<div class="paragraph">
<p>Use the following command line to start it from the parent&#8217;s directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn test -pl keycloak-dropwizard-jaxrs -am -Peycloak-dropwizard-jaxrs</pre>
</div>
</div>
<div class="paragraph">
<p>Once it is started, point your browser to <a href="http://localhost:9090" class="bare">http://localhost:9090</a> to see the application.</p>
</div>
<div class="paragraph">
<p>Enter a date like <code>2015-01-01</code> to see the predicted results of the given date.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-08-18 15:30:35 UTC
</div>
</div>
</body>
</html>